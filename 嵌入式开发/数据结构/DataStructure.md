# 数据结构

我们可以逐步推导这个公式，来理解如何得到 $D(N) = \frac{2}{N} \left( \sum_{j=0}^{N-1} D(j) \right) + N - 1$。

### 1. 基本设定

首先，$D(N)$ 是指包含 $N$ 个节点的树的内部路径长度。我们定义的递归关系是：

- $D(i)$ 是树中某个节点的左子树的路径长度。
- $D(N - i - 1)$ 是该节点右子树的路径长度。

公式 $D(N) = D(i) + D(N - i - 1) + N - 1$ 的含义是树的总路径长度由左右子树的路径长度之和，加上根节点到两个子树的连接边所需的深度。

### 2. 递归结构

我们将树看作是通过一个根节点分为左右两个子树。根据递归的方式，树的总深度是左右子树深度的和再加上一些常数项。具体来说：

- 左子树有 $i$ 个节点，右子树有 $N - i - 1$ 个节点，树的路径长度等于：

  D(N)=D(i)+D(N−i−1)+(N−1)D(N) = D(i) + D(N - i - 1) + (N - 1)

  其中 $(N - 1)$ 是因为根节点与左右子树之间有一个连接边。

### 3. 期望值的推导

为了得出期望值 $D(N)$，我们需要计算树的总路径长度的期望值。假设所有的 $i$ 值（从 $0$ 到 $N-1$）都可能出现，我们可以对它们进行平均：

$\mathbb{E}[D(N)] = \frac{1}{N} \sum_{i=0}^{N-1} D(i) + N - 1$

这里 $\sum_{i=0}^{N-1} D(i)$ 是所有子树路径长度之和，$\frac{1}{N}$ 是每个子树的平均贡献。

### 4. 求和项的倍数

进一步，我们注意到每个子树的路径长度贡献实际上有一个加权因子。每次递归都会有一个因子 $2$ 乘在期望值上（因为左右子树的深度之和会影响总路径长度），于是得到了：

$D(N) = \frac{2}{N} \left( \sum_{i=0}^{N-1} D(i) \right) + N - 1$

### 5. 解释

- **期望值**：通过将所有子树的深度加权平均后，我们得到了树的总深度的期望值。
- **$N - 1$**：这部分是由于树的根节点与左右子树之间的连接边造成的额外深度。

所以，最终得出的公式 $D(N) = \frac{2}{N} \left( \sum_{j=0}^{N-1} D(j) \right) + N - 1$ 是通过对每个子树的路径长度加权求和，并结合树的结构，得出树的总路径长度的期望值。

### 总结

这个公式的核心是递归关系和平均值的计算，通过对所有子树的深度进行加权求和，得出了树的期望深度。

让我们详细解析每次递归中的 $2$ 和 $N - 1$ 的出现。

### 1. 为什么每次递归有一个系数 2？

首先，公式中的 $D(N) = D(i) + D(N - i - 1) + N - 1$ 表示树的深度是由根节点到左子树和右子树的深度之和，再加上根节点与左右子树之间的连接边。因此，递归过程中涉及到 **左子树和右子树的深度**。

每个树的深度 $D(N)$ 是通过将一个树分为左子树和右子树来计算的。每次递归时，我们考虑到两棵子树的深度，左子树的深度是 $D(i)$，右子树的深度是 $D(N - i - 1)$。由于递归会在每个层次分别处理左子树和右子树，所以最终在期望值计算中会有一个 **2** 的因子。

更具体地说，计算时对于树中每个可能的分支（左子树和右子树），递归会分别计算左右两部分的深度。由于每次递归处理的是树的左右两部分（子树），因此我们最终得到的结果包含了左右两部分的贡献。为了把每个子树的贡献加权平均，最终的期望值有了一个 **2** 的因子，表示每次递归涉及到左右两个部分。

### 2. 为什么有 $N - 1$？

接下来说说公式中的 $N - 1$。

在递归关系中，公式 $D(N) = D(i) + D(N - i - 1) + N - 1$ 代表了树的总深度。这个公式中的 $N - 1$ 其实是 **根节点和左右子树之间的连接边的深度**。

在树的结构中，根节点连接了左右子树。对于一个包含 $N$ 个节点的树：

- **根节点** 是树的最上层节点，它与左子树和右子树之间各有一条边。
- 连接左子树和右子树的这条边的深度为 1（即树的根节点到左、右子树的边）。

因此，根节点到左右子树的两条边总共增加了一个额外的深度值，正好是 **$N - 1$**（即减去 1，因为这条连接边在递归计算的深度中计算了一次）。

### 3. 期望值的推导

在推导期望值时，公式中的 $\frac{2}{N}$ 是通过考虑 **每一个可能的子树** 来计算的。因为每个子树的深度 $D(i)$ 会影响树的整体深度（每个子树的深度在不同的分割点时变化），而我们需要计算这些不同分割点的平均值。

所以，递归的公式中 $2$ 和 $N - 1$ 分别表示：

- **2**：表示每次递归计算时左子树和右子树的深度都被考虑（即左右两个部分都需要计算）。
- **$N - 1$**：表示在树的根节点与左右子树之间的连接边的深度，它会影响树的总深度。

在这段文字中提到的 **$2^k - 1$** 是用来描述一个完全平衡二叉树（perfectly balanced tree）中节点的数量。

### 为什么是 $2^k - 1$？

1. **完全平衡二叉树的定义**：

   - 在一棵完全平衡的二叉树中，所有的叶子节点都位于同一层级，而每个节点都有零个或两个子节点。
   - 树的高度 $k$ 是指从根节点到叶子节点的最大路径长度（不包括根节点）。

2. **节点数量的推导**：

   - 对于高度为 $k$ 的完全平衡二叉树，假设树的每一层都是满的，也就是说每一层都有节点。
   - **第 0 层**（根节点）有 $1$ 个节点。
   - **第 1 层**有 $2$ 个节点。
   - **第 2 层**有 $4$ 个节点。
   - ...
   - **第 $k-1$ 层**有 $2^{k-1}$ 个节点。

   这样，树的总节点数就是所有层的节点数之和：

   1+2+4+8+⋯+2k−11 + 2 + 4 + 8 + \dots + 2^{k-1}

3. **求和公式**： 这个和是一个等比数列的求和。等比数列的求和公式是：

   S=a1⋅(rn−1)r−1S = \frac{a_1 \cdot (r^n - 1)}{r - 1}

   其中：

   - $a_1 = 1$ 是首项，
   - $r = 2$ 是公比，
   - $n = k$ 是项数。

   将这些值代入公式，得到：

   S=1⋅(2k−1)2−1=2k−1S = \frac{1 \cdot (2^k - 1)}{2 - 1} = 2^k - 1

   所以，总的节点数为 $2^k - 1$。

### 结论

在高度为 $k$ 的完全平衡二叉树中，节点的数量为 $2^k - 1$。这是因为每一层的节点数是指数级增长的，最终通过累加得到总节点数。